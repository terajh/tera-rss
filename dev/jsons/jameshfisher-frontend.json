[
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "The migration SQL should go in the table",
    "partialText": "<p>So you run <code>migrate</code> in your dev environment, but it fails:\nsome unknown migration <code>add-foobar</code> has already been applied from some other experimental branch,\nand the migration tool doesn’t know how to down-migrate it.\nTo fix it, you have to hunt for the branch that created that migration,\nto find its down-migration SQL.\nHopefully you still have that migration!</p>\n<p>I want <code>migrate</code> to always get me to my desired database schema,\nno matter what the current migration list looks like.\nBut no migration tools today have this property:\nthey always need a developer in the loop\nto find the down-migration SQL.</p>\n<p>Say the database has applied migrations <em>a → b → c</em>,\nbut we want <em>a → b → d</em>.\nThen <code>migrate</code> needs to run the down-migration for <em>c</em>, then run the up-migration for <em>d</em>.\nThis means <code>migrate</code> may need the down-migration SQL for any migration that has been applied.\nWe can guarantee this by storing the down-migration in the <code>migrations</code> table:</p>\n<pre><code>id  name         down_sql\n==  ===========  ====================================\n0   users-table  drop table users;\n1   email-col    alter table users drop column email;</code></pre>\n<p>All other migration tools I know of have a <code>migrations</code> table,\nbut they only store a list of migration names.\nThey assume you have the migration code checked out for the <em>current</em> database schema.\nThis is a bad assumption, even for your production database!\nSay a bad migration gets applied to your production database.\nYou should be able to roll back in the normal way: revert the commit and redeploy.\nBut with standard migration tools, this can’t work:\nthe down-migration SQL is lost in the revert!</p>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2025/11/18/the-migration-should-go-in-the-table/"
  },
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "A job queue in two lines of JS",
    "partialText": "<p>If you need a job queue in JS,\nyou can do it in two lines:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">Job</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">unknown</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> chain <span class=\"token operator\">=</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">enqueue</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>job<span class=\"token operator\">:</span> Job<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> chain <span class=\"token operator\">=</span> chain<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>job<span class=\"token punctuation\">,</span> job<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>For example, if your app makes API requests,\nyou may need requests to be processed in the order they were dispatched:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">setDone</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">done</span><span class=\"token operator\">:</span> boolean</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/todos/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> done <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Note that <code>chain.then(job)</code> is probably not what you want,\nbecause any rejection in the <code>chain</code> will cause the <code>job</code> to never run.\nInstead you want <code>chain.then(job, job)</code>,\nwhich will run <code>job</code> when the <code>chain</code> either rejects or resolves.</p>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2025/07/07/a-job-queue-in-two-lines-of-js/"
  },
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "Sticky snap: a better snapping algorithm",
    "partialText": "<p>The “snapping” feature in most drawing apps has a problem:\nyou can’t place the object near snap lines,\nso for precise positioning, you have to disable snapping.\nIn this post, I show <em>sticky snap</em>,\na better algorithm.\nBut first,\ntry to place the green rectangle at the target using the standard snap algorithm:</p>\n<p><canvas id=\"magnetic-snap-app\" style=\"display: block; margin: 0 auto\"></canvas></p>\n<p>You’ll soon find that it’s impossible to reach!\nThe snap lines always pull the object out of place.\nSometimes useful, but often very frustrating.\nTo complete this task, you’ll need to disable snapping!</p>\n<p>I call that standard algorithm <em>magnetic snap</em>,\nbecause the snap lines exert “action at a distance” on the thing you want to drag.\nNow for contrast, try out <em>sticky snap</em> on the same task:</p>\n<p><canvas id=\"sticky-snap-app\" style=\"display: block; margin: 0 auto\"></canvas></p>\n<p>With sticky snap, you can drag to the target\nby approaching it without touching the snap lines.\nHere, the snap lines are not magnetic, they’re <em>sticky</em>.\nThe snap lines don’t exert action at a distance;\nthey only exert force once you’ve stuck something to them.\nYou get the best of both worlds:\neasy to snap,\nbut also easy to avoid the snap line.</p>\n<p>I discovered sticky snap in macOS window management:\ntry dragging a window next to another one!\nNotice, unlike every other app with snapping,\nmacOS has no “window snap off” mode.\nThis is no coincidence:\nwith sticky snap, you don’t need to turn it off.</p>\n<p>Yet I haven’t seen sticky snap anywhere else.\nAll drawing apps I’ve tried use naive magnetic snap:\nFigma,\nGoogle Docs,\ntldraw,\nInkscape,\nKeynote, etc.\nAs such, all these apps have to make it easy to disable snapping,\nor even to start with snapping off.\nThey should all consider using sticky snap!</p>\n<script type=\"module\" src=\"./magnetic.js\"></script>\n<script type=\"module\" src=\"./sticky.js\"></script>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2025/06/29/a-better-snapping-algorithm/"
  },
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "`window.ai` hello world",
    "partialText": "<p>If you’re running Chrome with the <code>window.ai</code> API,\nhere’s a UI to prompt an LLM running locally in your browser:</p>\n<div>\n  <div style=\"display: flex; flex-direction: column\">\n    <h3>Prompt</h3>\n    <textarea id=\"prompt\" placeholder=\"Enter a prompt\" style=\"width: 100%; height: 100px;\"></textarea>\n    <div style=\"display: flex; flex-direction: row; gap: 10px;\">\n      <label>\n        Top K:\n        <input type=\"number\" id=\"topK\" value=\"1\" min=\"1\" max=\"100\" step=\"1\" style=\"width: 100%; margin-bottom: 10px;\">\n      </label>\n      <label>\n        Temperature:\n        <input type=\"number\" id=\"temperature\" value=\"0.5\" min=\"0\" max=\"5\" step=\"0.1\" style=\"width: 100%; margin-bottom: 10px;\">\n      </label>\n    </div>\n    <button id=\"run\" style=\"display: block;\">Run prompt</button>\n  </div>\n  <div>\n    <div>\n      Status: <span id=\"status\"></span>\n    </div>\n    <h3>Output</h3>\n    <div id=\"output\" style=\"border: 1px solid #ccc; padding: 10px; font-family: monospace;\"></div>\n  </div>\n</div>\n<script type=\"module\" src=\"./script.js\"></script>\n<p>I wrote these TypeScript type definitions for the API:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">declare</span> global <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">WindowOrWorkerGlobalScope</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">readonly</span> ai<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">canCreateTextSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token string\">\"readily\"</span> <span class=\"token operator\">|</span> <span class=\"token string\">\"after-download\"</span> <span class=\"token operator\">|</span> <span class=\"token string\">\"no\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">createTextSession</span><span class=\"token punctuation\">(</span>\n        options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>AITextSessionOptions<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>AITextSession<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">defaultTextSessionOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>AITextSessionOptions<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">AITextSession</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">prompt</span><span class=\"token punctuation\">(</span>input<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">promptStreaming</span><span class=\"token punctuation\">(</span>input<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> AsyncIterable<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> AITextSession<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Not yet implemented!</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">AITextSessionOptions</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  topK<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n  temperature<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2024/06/29/windowai-hello-world/"
  },
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "Interactive Turing patterns in WebGPU",
    "partialText": "<p>Below is an interactive Turing pattern.\nIt follows <a href=\"https://www.karlsims.com/rd.html\">Karl Sims’ model</a>.\nIt’s implemented in WebGPU.</p>\n<div>\n  <canvas id=\"example-canvas\" width=\"600\" height=\"600\"></canvas>\n</div>\n<div>\n  <label for=\"feed-rate\">Feed Rate: </label>\n  <input type=\"range\" id=\"feed-rate\" name=\"feed-rate\" min=\"0\" max=\"0.1\" step=\"0.001\" value=\"0.055\">\n  <span id=\"feed-rate-value\">0.055</span>\n</div>\n<div>\n  <label for=\"kill-rate\">Kill Rate: </label>\n  <input type=\"range\" id=\"kill-rate\" name=\"kill-rate\" min=\"0\" max=\"0.1\" step=\"0.001\" value=\"0.062\">\n  <span id=\"kill-rate-value\">0.062</span>\n</div>\n<script type=\"module\" src=\"script.js\"></script>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2024/05/29/interactive-turing-patterns-in-webgpu/"
  },
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "WebGPU hello world in 2024",
    "partialText": "<p>Below is a Game of Life simulation.\nIt uses WebGPU.</p>\n<div>\n  <canvas id=\"example-canvas\" width=\"600\" height=\"600\"></canvas>\n</div>\n<p>Here’s the essential JavaScript:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"example-canvas\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>navigator<span class=\"token punctuation\">.</span>gpu<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WebGPU not supported on this browser.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> adapter <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> navigator<span class=\"token punctuation\">.</span>gpu<span class=\"token punctuation\">.</span><span class=\"token function\">requestAdapter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>adapter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No appropriate GPUAdapter found.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> device <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> adapter<span class=\"token punctuation\">.</span><span class=\"token function\">requestDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"webgpu\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Canvas context not found\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\ncontext<span class=\"token punctuation\">.</span><span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">device</span><span class=\"token operator\">:</span> device<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">format</span><span class=\"token operator\">:</span> navigator<span class=\"token punctuation\">.</span>gpu<span class=\"token punctuation\">.</span><span class=\"token function\">getPreferredCanvasFormat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> encoder <span class=\"token operator\">=</span> device<span class=\"token punctuation\">.</span><span class=\"token function\">createCommandEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> pass <span class=\"token operator\">=</span> encoder<span class=\"token punctuation\">.</span><span class=\"token function\">beginRenderPass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">colorAttachments</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">view</span><span class=\"token operator\">:</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentTexture</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">loadOp</span><span class=\"token operator\">:</span> <span class=\"token string\">\"clear\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">clearValue</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">r</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">g</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">b</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">a</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">storeOp</span><span class=\"token operator\">:</span> <span class=\"token string\">\"store\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\npass<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndevice<span class=\"token punctuation\">.</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>encoder<span class=\"token punctuation\">.</span><span class=\"token function\">finish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>This is derived from <a href=\"https://codelabs.developers.google.com/your-first-webgpu-app\">this tutorial</a>.</p>\n<script type=\"module\" src=\"script.js\"></script>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2024/05/25/webgpu-hello-world-2024/"
  },
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "What is Monte Carlo integration?",
    "partialText": "<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css\" crossorigin=\"anonymous\">\n<script defer src=\"https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js\" crossorigin=\"anonymous\"></script>\n<script defer src=\"https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js\" crossorigin=\"anonymous\" onload=\"renderMath()\"></script>\n<script>\n  function renderMath() {\n    renderMathInElement(document.body,{\n              delimiters: [\n                  {left: \"\\\\[\", right: \"\\\\]\", display: true},\n                  {left: \"$\", right: \"$\", display: false},\n              ]\n    });\n  }\n</script>\n<p>What’s the average distance that someone can jump?\nLet’s estimate it!\nI have a silly function that gives me\nthe distance that someone can jump,\nbased on their height <code>h</code> in centimeters:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">jumpDistance</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">h</span><span class=\"token operator\">:</span> number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> number <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> h <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> h <span class=\"token operator\">></span> <span class=\"token number\">360</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token number\">300</span> <span class=\"token operator\">*</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token constant\">PI</span> <span class=\"token operator\">/</span> <span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Next we’ll describe the heights of people in the population.\nTo start, let’s say the population is just two people:\nJane is 160 cm tall, and Peter is 180 cm tall.\nThen we can estimate the average jump distance:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> janeJump <span class=\"token operator\">=</span> <span class=\"token function\">jumpDistance</span><span class=\"token punctuation\">(</span><span class=\"token number\">160</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> peterJump <span class=\"token operator\">=</span> <span class=\"token function\">jumpDistance</span><span class=\"token punctuation\">(</span><span class=\"token number\">180</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> averageJump <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>janeJump <span class=\"token operator\">+</span> peterJump<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></code></pre>\n<p>With a bigger population,\nwe can describe the population with an array of heights:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> populationHeights <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">160</span><span class=\"token punctuation\">,</span> <span class=\"token number\">180</span><span class=\"token punctuation\">,</span> <span class=\"token number\">170</span><span class=\"token punctuation\">,</span> <span class=\"token number\">190</span><span class=\"token punctuation\">,</span> <span class=\"token number\">150</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> totalJump <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> h <span class=\"token keyword\">of</span> populationHeights<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  totalJump <span class=\"token operator\">+=</span> <span class=\"token function\">jumpDistance</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> averageJump <span class=\"token operator\">=</span> totalJump <span class=\"token operator\">/</span> populationHeights<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span></code></pre>\n<p>For a yet larger population,\nwe can describe the population by keeping a tally for each height:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> populationHeights <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">[</span><span class=\"token number\">160</span><span class=\"token punctuation\">,</span> <span class=\"token number\">23</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span><span class=\"token number\">170</span><span class=\"token punctuation\">,</span> <span class=\"token number\">45</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span><span class=\"token number\">180</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span><span class=\"token number\">190</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> totalJump <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> totalPeople <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>h<span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">]</span> <span class=\"token keyword\">of</span> populationHeights<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  totalJump <span class=\"token operator\">+=</span> count <span class=\"token operator\">*</span> <span class=\"token function\">jumpDistance</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  totalPeople <span class=\"token operator\">+=</span> count<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> averageJump <span class=\"token operator\">=</span> totalJump <span class=\"token operator\">/</span> totalPeople<span class=\"token punctuation\">;</span></code></pre>\n<p>For an even larger population,\nwe can describe the population by a probability distribution,\nlike $\\text{Normal}(\\mu=170, \\sigma=20)$.\nThen the precise average jump distance is:</p>\n<p>\n  \\[\n    \\int_{h = -\\infty}^{\\infty} \\text{jumpDistance}(h) \\, \\text{Normal}(h; \\mu=170, \\sigma=20) \\, dh\n  \\]\n</p>\n<p>Yuck!\nSuddenly we can’t solve the problem by just running the code,\nbecause there are infinitely many heights to consider.\nOur nice finite loop turned into an infinite integral.\nAnd it’s horrible to solve analytically,\nespecially because <code>jumpDistance</code> is a piecewise function.</p>\n<p>What can we do instead?\nIf we have access to a function that gives us the population count at each height,\nwe can do what we were doing before,\nbut with some chosen heights:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">function</span> <span class=\"token function\">popCountForHeight</span><span class=\"token punctuation\">(</span>h<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">exp</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">0.5</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>h <span class=\"token operator\">-</span> <span class=\"token number\">170</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> totalJump <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> totalPeople <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> h <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> h <span class=\"token operator\">&lt;</span> <span class=\"token number\">360</span><span class=\"token punctuation\">;</span> h <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> count <span class=\"token operator\">=</span> <span class=\"token function\">popCountForHeight</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  totalJump <span class=\"token operator\">+=</span> count <span class=\"token operator\">*</span> <span class=\"token function\">jumpDistance</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  totalPeople <span class=\"token operator\">+=</span> count<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> averageJump <span class=\"token operator\">=</span> totalJump <span class=\"token operator\">/</span> totalPeople<span class=\"token punctuation\">;</span></code></pre>\n<p>This approach could be called a Riemann sum.\nOne problem with this approach is that\nwe need to know a range of heights to consider\nthat will cover most of the population,\nbut not too much that we’re wasting time on heights that are very unlikely.\nAbove, we chose to consider heights from 0 to 360 cm.</p>\n<p>Another approach is to sample from the distribution:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> populationHeights <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NormalDistribution</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">mean</span><span class=\"token operator\">:</span> <span class=\"token number\">170</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">stdDev</span><span class=\"token operator\">:</span> <span class=\"token number\">20</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> totalJump <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> totalPeople <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> h <span class=\"token operator\">=</span> populationHeights<span class=\"token punctuation\">.</span><span class=\"token function\">sample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  totalJump <span class=\"token operator\">+=</span> <span class=\"token function\">jumpDistance</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  totalPeople<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> averageJump <span class=\"token operator\">=</span> totalJump <span class=\"token operator\">/</span> totalPeople<span class=\"token punctuation\">;</span></code></pre>\n<p>Surprise, this is Monte Carlo integration!</p>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2024/04/24/what-is-monte-carlo-integration/"
  },
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "How to escape JavaScript for a script tag",
    "partialText": "<p>To add JavaScript to a web page,\nwe use a <code>&lt;script&gt;</code> tag like this:</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>But what if we need to add arbitrary JavaScript to our web page?\nSay, a valid script like this?:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span>y<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span></code></pre>\n<p>We can’t just write that in a <code>&lt;script&gt;</code> tag,\nbecause the browser will interpret the <code>&lt;!--</code> as the start of an HTML comment!</p>\n<p>“But that’s fine,” you think.\n“We can just escape the string.\nThis is how we serialize strings everywhere else in programming.”</p>\n<p>You might reach for HTML entities,\nreplacing <code>&lt;</code> with <code>&amp;lt;</code>.\nAfter all, isn’t the JavaScript just ordinary text content?\nNo, it’s not!\nOnce the browser sees a <code>&lt;script&gt;</code> tag,\nit goes into a <strong>special JavaScript parsing mode</strong>,\nwhere HTML entities are not interpreted!</p>\n<p>In this JavaScript parsing mode,\nthe browser is looking for one of two strings:</p>\n<ul>\n<li><code>&lt;/script</code> to end the script tag</li>\n<li><code>&lt;!--</code> to start an HTML comment</li>\n</ul>\n<p>To “escape” arbitrary JavaScript,\nwe need to avoid those two substrings.</p>\n<p>If we find <code>&lt;!--</code> in our JavaScript,\nwe can’t just replace it,\nbecause its meaning is context-dependent:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// This is a comment containing &lt;!--</span>\n<span class=\"token keyword\">let</span> foo <span class=\"token operator\">=</span> x <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span>y<span class=\"token punctuation\">;</span> <span class=\"token comment\">// That's valid JS operators</span>\n<span class=\"token keyword\">const</span> s <span class=\"token operator\">=</span> <span class=\"token string\">\"This is a string containing &lt;!--\"</span><span class=\"token punctuation\">;</span></code></pre>\n<p>To “escape” the above JavaScript,\nwe’d have to write something like:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// This is a comment containing</span>\n<span class=\"token keyword\">let</span> foo <span class=\"token operator\">=</span> x <span class=\"token operator\">&lt;</span> <span class=\"token operator\">!</span><span class=\"token operator\">--</span>y<span class=\"token punctuation\">;</span> <span class=\"token comment\">// That's valid JS operators</span>\n<span class=\"token keyword\">const</span> s <span class=\"token operator\">=</span> <span class=\"token string\">\"This is a string containing &lt;\"</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"!--\"</span><span class=\"token punctuation\">;</span></code></pre>\n<p>This is not a simple string replacement.\nTo do those replacements,\nwe need to parse the JavaScript,\nand handle every possible context where <code>&lt;!--</code> might appear.</p>\n<p><a href=\"https://html.spec.whatwg.org/multipage/scripting.html#restrictions-for-contents-of-script-elements\">Here’s the HTML spec.</a>\nIt’s all rather horrifying.</p>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2024/04/24/how-to-escape-javascript-for-a-script-tag/"
  },
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "On that flickering blur in Chrome",
    "partialText": "<p><code>backdrop-filter: blur</code> is a popular design for navbars.\nBut it’s unusable in its current state, due to its flickery appearance in Chrome.\nHere’s an example:</p>\n<div style=\"width: 25em; height: 15em; background: #eef; font-size: 0.8em; backdrop-filter: blur(0px); position: relative;\">\n  <div style=\"position: absolute; inset: 0; padding: 1em; overflow: scroll;\">\n    <div style=\"font-size: 2em; font-weight: bold; margin-top: 2em;\">A heading</div>\n    <p>\n      Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.\n      Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.\n    </p>\n  </div>\n  <div style=\"position: absolute; top: 1em; left: 1em; right: 1em; padding: 0.5em; border-radius: 0.5em; font-weight: bold; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); background: #aaa3;\">\n    Nav with a blurred background\n  </div>\n</div>\n<p>In Chrome, notice how even a 1px scroll\ncan cause the color to completely change.\nHere’s a recording:</p>\n<video controls autoplay loop muted playsinline style=\"max-width: 20em;\">\n  <source src=\"./recording.webm\" type=\"video/webm\">\n  Your browser does not support the video tag.\n</video>\n<p>Here’s the general problem:\na blur operation,\nat the edges of the image,\nneeds to know what the content is <em>outside</em> the image.\nThe <em>correct</em> approach would be to give the blur filter\nenough of the background content to work with.\nBut in Chrome, the blur is only given the pixels immediately behind the element.\nSo, as a hack, the blur must guess what the content is outside the nav.\n<a href=\"https://en.wikipedia.org/wiki/Kernel_(image_processing)#Edge_handling\">Wikipedia calls this “edge handling”.</a></p>\n<p>Chrome seems to take the <em>extend</em> strategy:\nit guesses that the pixels at the edge of the background image\nextend infinitely in all directions.\nThis is why the blur flickers so much:\na tiny scroll causes the edge pixels to change,\nwhich causes the extended pixels to completely change.</p>\n<p>One better edge-handing strategy is <em>mirroring</em>.\nMirroring is better because, even though it’s inaccurate, it results in smoother transitions.</p>\n<p>Neither Firefox nor Safari have this problem,\nalthough I’m not sure which approach they take to edge handling.</p>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2024/04/23/backdrop-blur-without-the-flickering/"
  },
  {
    "publisherId": "jameshfisher",
    "publisherName": "Jim Fisher",
    "specTitle": "웹 개발",
    "categories": [
      "frontend"
    ],
    "specUrl": "https://jameshfisher.com/feed.xml",
    "title": "What is the Metropolis algorithm?",
    "partialText": "<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css\" crossorigin=\"anonymous\">\n<script defer src=\"https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js\" crossorigin=\"anonymous\"></script>\n<script defer src=\"https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js\" crossorigin=\"anonymous\" onload=\"renderMath()\"></script>\n<script>\n  function renderMath() {\n    renderMathInElement(document.body,{\n              delimiters: [\n                  {left: \"\\\\[\", right: \"\\\\]\", display: true},\n                  {left: \"$\", right: \"$\", display: false},\n              ]\n    });\n  }\n</script>\n<p>We could estimate Bob’s lunch tomorrow\nby counting the previous lunches you’ve seen him eating in the cafeteria:</p>\n<table>\n<thead>\n<tr>\n<th>Lunch</th>\n<th>Count</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Apple</td>\n<td>2</td>\n</tr>\n<tr>\n<td>Banana</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<p>Now we want to simulate Bob’s future lunches.\nAssume Bob randomly picks a lunch each morning,\nwith the relative proportions you’ve observed.\nThen we can simulate Bob’s lunch with:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">Meal</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Apple\"</span> <span class=\"token operator\">|</span> <span class=\"token string\">\"Banana\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">sample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Meal <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span> <span class=\"token operator\">/</span> <span class=\"token number\">5</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"Apple\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Banana\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>$\\tfrac25$ of the samples will be <code>Apple</code>,\nand $\\tfrac35$ will be <code>Banana</code>.</p>\n<p>The Metropolis algorithm gives a different way\nto get samples with those correct proportions.\nIt looks like this:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">function</span> <span class=\"token function\">nextMeal</span><span class=\"token punctuation\">(</span>currentMeal<span class=\"token operator\">:</span> Meal<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Meal <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentMeal <span class=\"token operator\">===</span> <span class=\"token string\">\"Apple\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"Banana\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span> <span class=\"token operator\">/</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">\"Apple\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">\"Banana\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Chain</span> <span class=\"token punctuation\">{</span>\n  currentMeal<span class=\"token operator\">:</span> Meal<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentMeal <span class=\"token operator\">=</span> <span class=\"token string\">\"Apple\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">sample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Meal <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentMeal<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentMeal <span class=\"token operator\">=</span> <span class=\"token function\">nextMeal</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> current<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Yes:\nthis algorithm is more complicated and performs worse!\nBut the underlying technique can help us sample from more complex distributions.\nSo let’s see what it’s doing here, and why it works at all.</p>\n<p>Instead of each <code>sample</code> call being independent,\nthe Metropolis algorithm initializes a <code>Chain</code>\nwhich maintains a “current meal”.\nEach call to <code>sample</code> sets the next meal.</p>\n<p>Here’s one run of one chain:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> chain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Chain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Day </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">: </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> chain<span class=\"token punctuation\">.</span><span class=\"token function\">sample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre><code>Day 0:  Apple\nDay 1:  Banana\nDay 2:  Apple\nDay 3:  Banana\nDay 4:  Banana\nDay 5:  Apple\nDay 6:  Banana\nDay 7:  Banana\nDay 8:  Apple\nDay 9:  Banana</code></pre>\n<p>Notice Bob’s first meal is always <code>Apple</code>.\nAnd if Bob’s current meal is <code>Apple</code>,\nthe next meal is always <code>Banana</code>,\nso Bob’s second meal is always <code>Banana</code>.\nHere are two problems with the Metropolis algorithm:</p>\n<ol>\n<li>The first few samples are not in the correct distribution.</li>\n<li>Samples are dependent on the previous samples.</li>\n</ol>\n<p>Let’s run $10{,}000$ chains,\nand then log the distribution of apples on each day:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> chains<span class=\"token operator\">:</span> Chain<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> chains<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Chain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> samples <span class=\"token operator\">=</span> chains<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>chain<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> chain<span class=\"token punctuation\">.</span><span class=\"token function\">sample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> numApples <span class=\"token operator\">=</span> samples<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>sample<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> sample <span class=\"token operator\">===</span> <span class=\"token string\">\"Apple\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Num apples on day </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> numApples<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre><code>Num apples on day 0: 0\nNum apples on day 1: 6673\nNum apples on day 2: 2202\nNum apples on day 3: 5186\nNum apples on day 4: 3184\nNum apples on day 5: 4563\nNum apples on day 6: 3600\nNum apples on day 7: 4255\nNum apples on day 8: 3846\nNum apples on day 9: 4041</code></pre>\n<p>By day $9$, approximately $4{,}000$ of the $10{,}000$ chains have apples.\nThis is the correct proportion of $\\tfrac25$.\nBut the number bounces around before reaching this equilibrium.</p>\n<p>This is called <em>convergence</em>.\nTo analyze this more mathematically,\nwe can instead simulate the <em>distribution</em> of chains for the current meal,\nand calculate the distribution for the next meal:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">MealDist</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">nextMealDist</span><span class=\"token punctuation\">(</span>currentMealDist<span class=\"token operator\">:</span> MealDist<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MealDist <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>numApples<span class=\"token punctuation\">,</span> numBananas<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> currentMealDist<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Consider those eating apples today. What will they eat tomorrow?</span>\n  <span class=\"token keyword\">let</span> a2a <span class=\"token operator\">=</span> numApples <span class=\"token operator\">*</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// None will eat apples.</span>\n  <span class=\"token keyword\">let</span> a2b <span class=\"token operator\">=</span> numApples <span class=\"token operator\">*</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// All will eat bananas.</span>\n\n  <span class=\"token comment\">// Then consider those eating bananas today. What will they eat tomorrow?</span>\n  <span class=\"token keyword\">let</span> b2a <span class=\"token operator\">=</span> numBananas <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">/</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Two-thirds will eat apples.</span>\n  <span class=\"token keyword\">let</span> b2b <span class=\"token operator\">=</span> numBananas <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">/</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// The rest will eat bananas.</span>\n\n  <span class=\"token keyword\">const</span> numApplesTomorrow <span class=\"token operator\">=</span> a2a <span class=\"token operator\">+</span> b2a<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> numBananasTomorrow <span class=\"token operator\">=</span> a2b <span class=\"token operator\">+</span> b2b<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>numApplesTomorrow<span class=\"token punctuation\">,</span> numBananasTomorrow<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// To start, all 10,000 chains are eating apples.</span>\n<span class=\"token keyword\">let</span> currentMealDist<span class=\"token operator\">:</span> MealDist <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">10_000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  currentMealDist <span class=\"token operator\">=</span> <span class=\"token function\">nextMealDist</span><span class=\"token punctuation\">(</span>currentMealDist<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Num apples on day </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>currentMealDist<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Again, we see that by day $9$,\naround $\\tfrac25$ of the chains are eating apples:</p>\n<pre><code>Num apples on day 0: 0.000\nNum apples on day 1: 6666.667\nNum apples on day 2: 2222.222\nNum apples on day 3: 5185.185\nNum apples on day 4: 3209.877\nNum apples on day 5: 4526.749\nNum apples on day 6: 3648.834\nNum apples on day 7: 4234.111\nNum apples on day 8: 3843.926\nNum apples on day 9: 4104.049</code></pre>\n<p>Actually, we don’t need to start the distribution at <code>[10_000, 0]</code>.\nWe can just start with <code>[1, 0]</code>.\nThis is then a probability distribution,\nbecause the sum of the two numbers is $1$.\nThen the output is the probability distribution of the each meal:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">let</span> currentMealDist<span class=\"token operator\">:</span> MealDist <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  currentMealDist <span class=\"token operator\">=</span> <span class=\"token function\">nextMealDist</span><span class=\"token punctuation\">(</span>currentMealDist<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Probability of apples on day </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>currentMealDist<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre><code>Probability of apples on day 0: 0.000\nProbability of apples on day 1: 0.667\nProbability of apples on day 2: 0.222\nProbability of apples on day 3: 0.519\nProbability of apples on day 4: 0.321\nProbability of apples on day 5: 0.453\nProbability of apples on day 6: 0.365\nProbability of apples on day 7: 0.423\nProbability of apples on day 8: 0.384\nProbability of apples on day 9: 0.410</code></pre>\n<p>After 93 days, the probability of apples reaches a stable state,\nat least in 64-bit floating-point.\nAnd that stable state is the correct distribution:\n$\\tfrac25$ apple and $\\tfrac35$ banana.</p>\n<p>Because the first samples are not in the correct distribution,\nit’s common to discard them.\nThis is called <em>burn-in</em>.</p>\n<p>The precise claim of the Metroplis algorithm is:\nthe <em>correct</em> distribution is a <em>stable</em> distribution.\nTo prove this,\nevaluate <code>nextMealDist([2/5, 3/5])</code>,\nand you’ll see that it’s <code>[2/5, 3/5]</code>.\nHow many will eat <code>Apple</code> for the next meal?\nNone of the $\\tfrac25$ currently eating apples will eat apples tomorrow.\nOf the $\\tfrac35$ currently eating bananas,\n$\\tfrac23$ will eat apples tomorrow.\nfor a total of $\\tfrac35 \\times \\tfrac23 = \\tfrac25$.\nAnd so the probability of $\\tfrac25$ is maintained.</p>\n<p>The example algorithm above was hard-coded\nto generate the stable state $\\tfrac25$ and $\\tfrac35$.\nBut time passes,\nafter which we’ve counted $3$ apple meals, and $6$ banana meals.\nLet’s update the algorithm to work with any counts:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// Our observed counts.</span>\n<span class=\"token comment\">// We want to generate more meals in this proportion.</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">A</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Count of apples</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">B</span> <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Count of bananas</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">nextMeal</span><span class=\"token punctuation\">(</span>currentMeal<span class=\"token operator\">:</span> Meal<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Meal <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentMeal <span class=\"token operator\">===</span> <span class=\"token string\">\"Apple\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"Banana\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">A</span> <span class=\"token operator\">/</span> <span class=\"token constant\">B</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">\"Apple\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">\"Banana\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Let’s show that, for any counts $A$ and $B$,\nthis converges to the correct probability distribution,\n$\\tfrac{A}{A+B}$ and $\\tfrac{B}{A+B}$.</p>\n<p>\n  \\[\n  \\begin{aligned}\n    \\texttt{numApples} &= \\tfrac{A}{A+B} \\\\\n    \\texttt{numBananas} &= \\tfrac{B}{A+B} \\\\\n    \\\\\n    \\texttt{a2a} &= 0 \\\\\n    \\texttt{b2a} &= \\texttt{numBananas} \\times \\tfrac{A}{B} \\\\\n                 &= \\tfrac{B}{A+B} \\times \\tfrac{A}{B} \\\\\n                 &= \\tfrac{BA}{(A+B)B} \\\\\n                 &= \\tfrac{A}{A+B} \\\\\n    \\\\\n    \\texttt{numApplesTomorrow} &= \\texttt{a2a} + \\texttt{b2a} \\\\\n                               &= 0 + \\tfrac{A}{A+B} \\\\\n                               &= \\tfrac{A}{A+B} \\\\\n  \\end{aligned}\n  \\]\n</p>\n<p>So far, we’ve only observed Bob eating <code>Apple</code> or <code>Banana</code>.\nBut then one day Bob’s in the cafeteria eating <code>Chips</code>!\nWe need to handle more states.\nWe can record our observed frequencies with a function <code>f</code>:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">function</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>meal<span class=\"token operator\">:</span> Meal<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    Apple<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n    Banana<span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n    Chips<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span>meal<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>The true Metropolis <code>sample</code> algorithm actually starts by <em>proposing</em> a new meal.\nThen it decides whether to change to that meal,\nor eat the current meal again.\nHere’s a proposal function\nthat picks from possible meals with uniform probability:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">function</span> <span class=\"token function\">proposeMeal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Meal <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> meals<span class=\"token operator\">:</span> Meal<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Apple\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Banana\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Chips\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> i <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> meals<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Then the true <code>nextMeal</code> function looks like:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">function</span> <span class=\"token function\">nextMeal</span><span class=\"token punctuation\">(</span>currentMeal<span class=\"token operator\">:</span> Meal<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Meal <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> proposedMeal <span class=\"token operator\">=</span> <span class=\"token function\">proposeMeal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> proposedMealFreq <span class=\"token operator\">=</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>proposedMeal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> currentMealFreq <span class=\"token operator\">=</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>currentMeal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// The key line!</span>\n  <span class=\"token keyword\">const</span> transitionProb <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>proposedMealFreq <span class=\"token operator\">/</span> currentMealFreq<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> transitionProb<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> proposedMeal<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> currentMeal<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>This works, but <em>why</em> does it work?\nThe key point in the proof is that,\nfor any two states $A$ and $B$ in the steady state,\nthe probability mass transferred from $A$ to $B$ is\nthe same as the probability mass transferred from $B$ to $A$.</p>\n<p>Let’s prove that.\nIf we’re in steady state,\nevery state $S$ has mass proportional to $f(S)$.\nFor simplicity, just say the mass at $S$ is $f(S)$.\nWithout loss of generality, let’s assume $f(A) \\leq f(B)$.</p>\n<p>How much mass is transferred from state $A$ to $B$?\nWith our uniform proposal function,\n$\\tfrac1N^{th}$ of the mass at $A$ is proposed to move to $B$.\nThe probability of accepting this proposal is $\\text{min}(1,\\tfrac{f(B)}{f(A)})$.\nSince $f(A) \\leq f(B)$, this is $1$, i.e. the proposal is always accepted.\nSo the mass moving from $A$ to $B$ is $\\tfrac{f(A)}{N}$.</p>\n<p>How much mass is transferred from state $B$ to $A$?\nAgain, $\\tfrac1N^{th}$ of the mass at $B$ is proposed to move to $A$.\nThe probability of accepting this proposal is $\\text{min}(1,\\tfrac{f(A)}{f(B)})$.\nSince $f(A) \\leq f(B)$, this is $\\tfrac{f(A)}{f(B)}$.\nSo the mass moving from $B$ to $A$ is $\\tfrac{f(B)}{N} \\times \\tfrac{f(A)}{f(B)} = \\tfrac{f(A)}{N}$.</p>\n<p>The same amount of mass, $\\tfrac{f(A)}{N}$, is transferred from $A$ to $B$ as from $B$ to $A$.\nThis condition is called <em>detailed balance</em>,\nand it implies that we are in a steady state.</p>\n<p>The <code>proposeMeal</code> function above just picks a meal uniformly at random.\nBut we want to propose meals in proportion to their frequency.\nThe only requirement is that the proposal function\nis <em>symmetric</em>: the probability of proposing $A$ from $B$\nis the same as the probability of proposing $B$ from $A.\n(Try to prove that this results in detailed balance.)</p>\n<p>So far, we’ve been using discrete states.\nBut the Metropolis algorithm is most useful for continuous distributions.\nHere’s a weird distribution over the real numbers:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">function</span> <span class=\"token function\">sinFreq</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">&lt;</span> x <span class=\"token operator\">&amp;&amp;</span> x <span class=\"token operator\">&lt;</span> Math<span class=\"token punctuation\">.</span><span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>We can sample from this distribution\nusing the Metropolis algorithm in its full generality:</p>\n<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Chain<span class=\"token operator\">&lt;</span>State<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token comment\">// Initial state</span>\n    <span class=\"token keyword\">private</span> state<span class=\"token operator\">:</span> State<span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// Function to calculate the frequency of any state</span>\n    <span class=\"token keyword\">private</span> <span class=\"token function-variable function\">f</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>state<span class=\"token operator\">:</span> State<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// Function to propose a new state - must be symmetric</span>\n    <span class=\"token keyword\">private</span> <span class=\"token function-variable function\">propose</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>state<span class=\"token operator\">:</span> State<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> State<span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// Number of initial samples to discard</span>\n    burnIn <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> burnIn<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">sample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">sample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> State <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> current <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> proposed <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">propose</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> prob <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">f</span><span class=\"token punctuation\">(</span>proposed<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">f</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> next <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> prob <span class=\"token operator\">?</span> proposed <span class=\"token operator\">:</span> current<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> current<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">propose</span><span class=\"token punctuation\">(</span>currentState<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> currentState <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> chain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Chain</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> sinFreq<span class=\"token punctuation\">,</span> propose<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> numSamples <span class=\"token operator\">=</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> buckets<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">number</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> numSamples<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> sample <span class=\"token operator\">=</span> chain<span class=\"token punctuation\">.</span><span class=\"token function\">sample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> bucket <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>sample <span class=\"token operator\">*</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  buckets<span class=\"token punctuation\">[</span>bucket<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>buckets<span class=\"token punctuation\">[</span>bucket<span class=\"token punctuation\">]</span> <span class=\"token operator\">??</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> bucket <span class=\"token keyword\">in</span> buckets<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  buckets<span class=\"token punctuation\">[</span>bucket<span class=\"token punctuation\">]</span> <span class=\"token operator\">/=</span> numSamples<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> bucket <span class=\"token keyword\">in</span> buckets<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> len <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>buckets<span class=\"token punctuation\">[</span>bucket<span class=\"token punctuation\">]</span><span class=\"token operator\">!</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">repeat</span><span class=\"token punctuation\">(</span>len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Sure enough,\nhere’s that weird lumpy distribution:</p>\n<pre><code>#\n###\n######\n########\n##########\n#############\n##############\n################\n##################\n####################\n######################\n#######################\n########################\n########################\n#########################\n#########################\n#########################\n#########################\n########################\n#######################\n######################\n#####################\n###################\n##################\n################\n##############\n############\n#########\n#######\n####\n##\n\n##\n#####\n#######\n#########\n###########\n##############\n###############\n#################\n###################\n#####################\n######################\n#######################\n########################\n########################\n#########################\n########################\n########################\n########################\n#######################\n######################\n#####################\n###################\n#################\n################\n##############\n############\n##########\n#######\n#####\n###</code></pre>",
    "date": "2026-02-18T15:57:12.690Z",
    "url": "https://jameshfisher.com/2024/04/18/metropolis-algorithm/"
  }
]